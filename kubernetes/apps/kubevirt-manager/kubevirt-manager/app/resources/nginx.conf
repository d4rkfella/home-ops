user  nginx;
worker_processes  auto;

error_log  /var/log/openresty/error.log notice;
pid        /var/log/openresty/nginx.pid;

env OIDC_REDIRECT_URI;
env OIDC_DISCOVERY;
env OIDC_TOKEN_ENDPOINT_AUTH_METHOD;
env OIDC_CLIENT_ID;
env OIDC_CLIENT_SECRET;
env OIDC_SSL_VERIFY;
env OIDC_KEEPALIVE;
env OIDC_RESPONSE_MODE;
env OIDC_SCOPE;
env OIDC_REFRESH_SESSION_INTERVAL;
env OIDC_REDIRECT_URI_SCHEME;
env OIDC_LOGOUT_PATH;
env OIDC_REDIRECT_AFTER_LOUGOUT_URI;
env OIDC_REDIRECT_AFTER_LOGOUT_URI_WITH_ID_TOKEN;
env OIDC_REDIRECT_URI;
env OIDC_ACCEPT_NONE_ALG;
env OIDC_ACCEPT_UNSUPPORTED_ALG;
env OIDC_RENEW_ACCESS_TOKEN;
env OIDC_ACCESS_TOKEN_EXPIRES_IN;
env OIDC_ACCESS_TOKEN_EXPIRES_LEEWAY;
env OIDC_USE_NONCE;
env OIDC_REVOKE_TOKENS_ON_LOGOUT;
env OIDC_USE_PKCE;
env SESSION_AUDIENCE;
env OIDC_REDIS_HOST;
env OIDC_REDIS_PORT;
env OIDC_REDIS_USE_SSL;
env OIDC_REDIS_SSL_VERIFY;
env OIDC_REDIS_PASSWORD;

events {
    worker_connections  1024;
}

http {
    lua_shared_dict discovery 1m;
    lua_shared_dict sessions 10m;
    lua_package_path '~/lua/?.lua;;';

    resolver 172.17.0.10;

    init_by_lua_block {
        local ssl = require "ngx.ssl"
        local fs = require "ngx.fs"
        local certs_dir = "/etc/ssl/certs"
        for cert_file in fs.dir(certs_dir) do
            if cert_file:match("%.crt$") then  -- Only process .crt files
                local cert_path = certs_dir .. "/" .. cert_file
                local cert_data = fs.read_file(cert_path)
                if cert_data then
                    local ok, err = ssl.set_trusted_certificate(cert_data)
                    if not ok then
                        ngx.log(ngx.ERR, "Failed to load certificate: ", cert_path, ", error: ", err)
                    end
                end
            end
        end
        require "resty.session".init({
          audience = os.getenv("SESSION_AUDIENCE"),
          storage = "redis",
          redis = {
            host = os.getenv("OIDC_REDIS_HOST"),
            port = os.getenv("OIDC_REDIS_PORT") or 6379,
            ssl = os.getenv("OIDC_REDIS_USE_SSL") or true,
            ssl_verify = os.getenv("OIDC_REDIS_SSL_VERIFY") or true,
            password = os.getenv("OIDC_REDIS_PASSWORD")
          }
        })
    }

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/openresty/access.log  main;


    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}
