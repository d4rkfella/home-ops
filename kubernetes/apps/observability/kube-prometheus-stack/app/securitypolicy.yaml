apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: alertmanager
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: kube-prometheus-stack-alertmanager
  jwt:
    providers:
    - name: keycloak
      extractFrom:
        cookies:
        - AccessToken-5d351a15
      remoteJWKS:
        uri: https://accounts.darkfellanetwork.com/realms/DarkfellaNET/protocol/openid-connect/certs
  authorization:
    defaultAction: Deny
    rules:
    - name: "allow"
      action: Allow
      principal:
        jwt:
          provider: keycloak
          claims:
          - name: preferred_username
            values: ["darkfella"]
  oidc:
    provider:
      issuer: "https://accounts.darkfellanetwork.com/realms/DarkfellaNET"
      authorizationEndpoint: "https://accounts.darkfellanetwork.com/realms/DarkfellaNET/protocol/openid-connect/auth"
      tokenEndpoint: "https://accounts.darkfellanetwork.com/realms/DarkfellaNET/protocol/openid-connect/token"
    clientID: "62e859f7-c3c2-463d-87de-4d05ecc27776"
    clientSecret:
      name: "alertmanager-secret"
    redirectURL: "https://alertmanager.darkfellanetwork.com/oauth2/callback"
    logoutPath: "/logout"
    cookieDomain: "alertmanager.darkfellanetwork.com"
    refreshToken: true
    scopes: ["openid", "profile", "email"]
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: alertmanager-api
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: kube-prometheus-stack-alertmanager-api
  jwt:
    providers:
    - name: keycloak
      audiences: ["b257908e-34ad-4933-98a0-ca00ff6fcfdd", "46f5398b-91b2-4706-bfc3-5f2f4ad624fc", "1ec97925-af53-40cf-aee1-d9eae03ddebd"]
      remoteJWKS:
        uri: https://accounts.darkfellanetwork.com/realms/DarkfellaNET/protocol/openid-connect/certs
  #authorization:
    #defaultAction: Deny
    #rules:
    #- name: "allow"
      #action: Allow
      #principal:
        #jwt:
          #provider: keycloak
          #claims:
          #- name: groups
            #values: ["Prometheus_Service_Account", "Admins", "FluxAlerts_Service_Account"]
