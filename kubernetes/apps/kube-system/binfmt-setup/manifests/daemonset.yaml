apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: binfmt-setup
spec:
  selector:
    matchLabels:
      app: binfmt-setup
  template:
    metadata:
      labels:
        app: binfmt-setup
    spec:
      tolerations:
        - operator: Exists
      initContainers:
      - name: mount-binfmt
        image: docker.io/library/busybox:1.37
        securityContext:
          privileged: true
        command: ["/bin/sh", "-c"]
        args:
          - |
            if ! grep -q 'binfmt_misc' /proc/mounts; then
              echo "Mounting binfmt_misc..."
              mount -t binfmt_misc binfmt_misc /proc/sys/fs/binfmt_misc
              echo 1 > /proc/sys/fs/binfmt_misc/status
            else
              echo "Already mounted, ensuring activation..."
              echo 1 > /proc/sys/fs/binfmt_misc/status || true
            fi

            ls /proc/sys/fs/binfmt_misc
        volumeMounts:
        - name: host-proc
          mountPath: /proc
          mountPropagation: Bidirectional
      - name: binfmt-install
        image: tonistiigi/binfmt
        args:
          - '--install'
          - arm64
        imagePullPolicy: IfNotPresent
        securityContext:
          privileged: true
      containers:
        - name: pause
          image: gcr.io/google_containers/pause
          resources:
            limits:
              cpu: 50m
              memory: 50Mi
            requests:
              cpu: 50m
              memory: 50Mi
      volumes:
      - name: host-proc
        hostPath:
          path: /proc
          type: Directory
