---
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: flux-instance
  namespace: flux-system
spec:
  interval: 1h
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 0.33.0
  url: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance
  verify:
    provider: cosign
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-instance
spec:
  interval: 5m
  chartRef:
    kind: OCIRepository
    name: flux-instance
  values:
    instance:
      distribution:
        artifact: oci://ghcr.io/controlplaneio-fluxcd/flux-operator-manifests:v0.33.0
        version: 2.x
      cluster:
        networkPolicy: false
      storage:
        class: openebs-zfs-128k
        size: 20Gi
      components:
        - source-controller
        - kustomize-controller
        - helm-controller
        - notification-controller
      sync:
        kind: GitRepository
        url: https://github.com/d4rkfella/home-ops
        ref: refs/heads/main
        path: kubernetes/flux/cluster
        interval: 1h
        recurseSubmodules: true
      kustomize:
        patches:
          # Increase the number of workers and limits
          # Ref: https://fluxcd.io/flux/installation/configuration/vertical-scaling/#increase-the-number-of-workers-and-limits
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=10
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --requeue-dependency=5s
            target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: all
              spec:
                template:
                  spec:
                    containers:
                      - name: manager
                        resources:
                          limits:
                            memory: 2Gi
            target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
          # Enable in-memory kustomize builds
          # Ref: https://fluxcd.io/flux/installation/configuration/vertical-scaling/#enable-in-memory-kustomize-builds
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=20
              - op: replace
                path: /spec/template/spec/volumes/0
                value:
                  name: temp
                  emptyDir:
                    medium: Memory
            target:
              kind: Deployment
              name: kustomize-controller
          # Enable Helm repositories caching
          # Ref: https://fluxcd.io/flux/installation/configuration/vertical-scaling/#enable-helm-repositories-caching
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-max-size=30
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-ttl=60m
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-purge-interval=5m
            target:
              kind: Deployment
              name: source-controller
          # Flux near OOM detection for Helm
          # Ref: https://fluxcd.io/flux/installation/configuration/helm-oom-detection/
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=OOMWatch=true
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-memory-threshold=95
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-interval=500ms
            target:
              kind: Deployment
              name: helm-controller
          # Add app.kubernetes.io/name label to kustomize-controller pods
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: kustomize-controller
              spec:
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: kustomize-controller
            target:
              kind: Deployment
              name: kustomize-controller

          # Add app.kubernetes.io/name label to helm-controller pods
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: helm-controller # Match target name
              spec:
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: helm-controller
            target:
              kind: Deployment
              name: helm-controller

          # Add app.kubernetes.io/name label to source-controller pods
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: source-controller # Match target name
              spec:
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: source-controller
            target:
              kind: Deployment
              name: source-controller

          # Add app.kubernetes.io/name label to notification-controller pods
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: notification-controller
              spec:
                template:
                  metadata:
                    labels:
                      app.kubernetes.io/name: notification-controller
            target:
              kind: Deployment
              name: notification-controller

          - patch: |
              - op: add
                path: /spec/template/spec/hostUsers
                value: false
            target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller|notification-controller)

          - # Disable chart digest tracking
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=DisableChartDigestTracking=true
            target:
              kind: Deployment
              name: helm-controller

          - # Controller-level SOPS decryption
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --sops-age-secret=sops-age-secret
            target:
              kind: Deployment
              name: kustomize-controller
          - # Watch configmaps and secrets attached to HelmReleases and Kustomizations
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --watch-configs-label-selector=owner!=helm
            target:
              kind: Deployment
              name: (helm-controller|kustomize-controller)

          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --log-level=debug
            target:
              kind: Deployment
              name: helm-controller
