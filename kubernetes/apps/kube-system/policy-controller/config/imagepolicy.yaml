apiVersion: policy.sigstore.dev/v1beta1
kind: ClusterImagePolicy
metadata:
  name: enforce-sig-and-slsa
spec:
  images:
  - glob: "ghcr.io/d4rkfella/**"
  authorities:
  - keyless:
      url: https://github.com/d4rkfella/*/.github/workflows/apko-build.yaml
      identities:
        - issuer: https://token.actions.githubusercontent.com
          subjectRegExp: ^https://github.com/d4rkfella/[^/]+/.github/workflows/apko-build.yaml@refs/heads/main$
    attestations:
      - name: slsa-provenance
        predicateType: https://slsa.dev/provenance/v1
        policy:
          type: cue
          data: |
            predicate.buildDefinition.externalParameters.repository =~ "^https://github\.com/d4rkfella/[^/]+$"
            predicate.runDetails.builder.id =~ "^https://github\.com/d4rkfella/[^/]+/.github/workflows/apko-build\.yaml@refs/heads/main$"
