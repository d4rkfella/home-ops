apiVersion: v1
kind: ConfigMap
metadata:
  name: scripts
data:
  create_zpool.sh: |
    #!/usr/bin/env bash
    set -Eeuo pipefail

    ###############################################################################
    # Configuration
    ###############################################################################

    : "${POOL_NAME:=zfspool}"
    : "${WIPE_DISKS:=false}"

    ###############################################################################
    # Logging
    ###############################################################################

    log() {
        printf '[%s] %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$*"
    }

    fatal() {
        log "ERROR: $*"
        exit 1
    }

    ###############################################################################
    # Required environment variables
    ###############################################################################

    [ -n "${TALOS_VERSION:-}" ] || fatal "TALOS_VERSION is not set"
    [ -n "${DEVICES:-}" ]       || fatal "DEVICES is not set"
    [ -n "${ASHIFT:-}" ]        || fatal "ASHIFT is not set"

    ###############################################################################
    # ZFS installation (Talos extension)
    ###############################################################################

    log "Resolving ZFS extension for Talos ${TALOS_VERSION}"

    ZFS_IMAGE="$(
        crane export "ghcr.io/siderolabs/extensions:${TALOS_VERSION}" \
            | tar x -O image-digests \
            | awk '/zfs/ { print $1; exit }'
    )" || fatal "Unable to resolve ZFS extension image"

    [ -n "$ZFS_IMAGE" ] || fatal "No ZFS extension found for Talos ${TALOS_VERSION}"

    log "Verifying ZFS extension signature"

    cosign verify \
        --certificate-identity-regexp '@siderolabs\.com$' \
        --certificate-oidc-issuer https://accounts.google.com \
        "$ZFS_IMAGE" >/dev/null 2>&1 \
        || fatal "ZFS extension signature verification failed"

    log "Installing ZFS utilities"

    crane export "$ZFS_IMAGE" | tar --strip-components=1 -x -C / \
        || fatal "Failed to install ZFS extension"

    ###############################################################################
    # Device validation
    ###############################################################################

    read -ra DEV_ARRAY <<< "$DEVICES"

    for dev in "${DEV_ARRAY[@]}"; do
        [ -e "$dev" ] || fatal "Device not found: $dev"
    done

    ###############################################################################
    # Idempotency checks
    ###############################################################################

    if zpool list -H -o name 2>/dev/null | grep -qx "$POOL_NAME"; then
        log "ZFS pool '${POOL_NAME}' already exists; skipping further actions"
        zpool status "$POOL_NAME"
        exit 0
    fi

    fs_detected=false
    for dev in "${DEV_ARRAY[@]}"; do
        if blkid "$dev" >/dev/null 2>&1; then
            log "Existing disk signature detected on ${dev}"
            fs_detected=true
        fi
    done

    if [[ "$fs_detected" == "true" && "$WIPE_DISKS" != "true" ]]; then
        log "Disk signatures present and WIPE_DISKS is disabled; skipping pool creation"
        exit 0
    fi

    ###############################################################################
    # Optional disk wipe
    ###############################################################################

    if [[ "$fs_detected" == "true" && "$WIPE_DISKS" == "true" ]]; then
        log "Disk wipe enabled; clearing existing signatures"

        for dev in "${DEV_ARRAY[@]}"; do
            log "Clearing filesystem signatures on ${dev}"
            wipefs -a "$dev"
        done
    fi

    ###############################################################################
    # ZFS pool creation (mirrored vdevs)
    ###############################################################################

    if (( ${#DEV_ARRAY[@]} % 2 != 0 )); then
        fatal "Mirror configuration requires an even number of devices"
    fi

    ZPOOL_CMD=(
        zpool create
        -m legacy
        -o "ashift=${ASHIFT}"
        -f
        "$POOL_NAME"
    )

    for (( i=0; i<${#DEV_ARRAY[@]}; i+=2 )); do
        ZPOOL_CMD+=("mirror" "${DEV_ARRAY[i]}" "${DEV_ARRAY[i+1]}")
    done

    log "Creating ZFS pool '${POOL_NAME}'"

    "${ZPOOL_CMD[@]}" || fatal "ZFS pool creation failed"

    log "ZFS pool '${POOL_NAME}' successfully created"
    zpool status "$POOL_NAME"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-zpool
  namespace: kube-system
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 0
  template:
    metadata:
      labels:
        job-name: create-zpool
    spec:
      containers:
      - name: create-zpool
        image: alpine:3.23
        command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache bash curl crane cosign libuuid e2fsprogs
              /scripts/create_zpool.sh
        securityContext:
          privileged: true
        env:
        - name: DEVICES
          value: "/dev/sda /dev/sdb /dev/sdc /dev/sdd"
        - name: ASHIFT
          value: "12"
        - name: POOL_NAME
          value: "ssd_pool"
        - name: TALOS_VERSION
          value: "v1.12.0"
        resources:
          limits:
            cpu: "1"
            memory: "512Mi"
          requests:
            cpu: "500m"
            memory: "256Mi"
        volumeMounts:
        - name: dev
          mountPath: /dev
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: dev
        hostPath:
          path: /dev
      - name: scripts
        configMap:
          name: scripts
          defaultMode: 0755
      restartPolicy: Never
