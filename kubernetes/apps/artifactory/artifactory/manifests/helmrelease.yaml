---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: artifactory
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: artifactory
  postRenderers:
  - kustomize:
      patches:
        - target:
            kind: "StatefulSet"
            name: "artifactory"
          patch: |-
            - op: add
              path: /spec/template/spec/hostUsers
              value: false
            - op: add
              path: /spec/template/spec/imagePullSecrets
              value:
                - name: artifactory-secret
  values:
    mc:
      enabled: true
    access:
      accessConfig:
        security:
          tls: true
      customCertificatesSecretName: artifactory-ca
    jfconnect:
      enabled: true
    onemodel:
      enabled: true
    artifactory:
      statefulset:
        annotations:
          reloader.stakater.com/auto: "true"
      license:
        secret: artifactory-secret
        dataKey: license-key
      image:
        registry: ghcr.io
        repository: d4rkfella/artifactory-pro
        tag: 7.125.10@sha256:3d298588d97b9894343b36dab8207055cc07e6ee6ebb043bdde0b95103647b4d
        pullPolicy: IfNotPresent
      persistence:
        size: 200Gi
      extraSystemYaml:
        artifactory:
          tomcat:
            httpsConnector:
                enabled: true
      masterKeySecretName: &secret artifactory-secret
      joinKeySecretName: *secret
      admin:
        secret: artifactory-secret
        dataKey: bootstrap.creds
    postgresql:
      enabled: false
    database:
      type: "postgresql"
      driver: org.postgresql.Driver
      secrets:
        user:
          name: *secret
          key: "db-user"
        password:
          name: *secret
          key: "db-password"
        url:
          name: *secret
          key: "db-url"
    nginx:
      enabled: false
