---
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: artifactory
spec:
  interval: 1h
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 107.125.6
  url: oci://ghcr.io/d4rkfella/charts-mirror/artifactory
  verify:
    provider: cosign
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: artifactory
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: artifactory
  postRenderers:
  - kustomize:
      patches:
        - target:
            kind: "StatefulSet"
            name: "artifactory"
          patch: |-
            - op: add
              path: /spec/template/spec/hostUsers
              value: false
            - op: add
              path: /spec/template/spec/imagePullSecrets
              value:
                - name: ghcr-pull-secret
  values:
    mc:
      enabled: true
    access:
      accessConfig:
        security:
          tls: true
      customCertificatesSecretName: artifactory-ca
    jfconnect:
      enabled: true
    onemodel:
      enabled: true
    artifactory:
      statefulset:
        annotations:
          reloader.stakater.com/auto: "true"
      license:
        secret: artifactory-secret
        dataKey: license-key
      image:
        registry: ghcr.io
        repository: d4rkfella/artifactory-pro
        tag: 7.125.6
        digest: sha256:89a8a6f09cfb88c45da613903ded11832371c63ae8aab78eaede0716b12819fc
        pullPolicy: IfNotPresent
      persistence:
        size: 200Gi
      extraSystemYaml:
        artifactory:
          tomcat:
            httpsConnector:
                enabled: true
      masterKeySecretName: artifactory-secret
      joinKeySecretName: artifactory-secret
      admin:
        secret: artifactory-secret
        dataKey: bootstrap.creds
      customInitContainers: |
        - name: "init-db"
          image: ghcr.io/d4rkfella/postgres-init:0.1.0@sha256:bf523baf0575d7a44a6572f50d7188db225e0642d80158093cd1f4ffa61cc317
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities: { drop: ["ALL"] }
            seccompProfile: { type: RuntimeDefault }
          env:
            - name: POSTGRES_HOST
              value: postgres-db-rw.database.svc.cluster.local
            - name: POSTGRES_DBNAME
              value: artifactory
            - name: POSTGRES_PASS
              valueFrom:
                secretKeyRef:
                  name: artifactory-secret
                  key: db-password
            - name: POSTGRES_SSLMODE
              value: require
            - name: POSTGRES_SUPER_PASS
              valueFrom:
                secretKeyRef:
                  name: artifactory-secret
                  key: POSTGRES_SUPER_PASS
            - name: POSTGRES_SUPER_USER
              value: postgres
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: artifactory-secret
                  key: db-user
    postgresql:
      enabled: false
    database:
      type: "postgresql"
      driver: org.postgresql.Driver
      secrets:
        user:
          name: &secret artifactory-secret
          key: "db-user"
        password:
          name: *secret
          key: "db-password"
        url:
          name: *secret
          key: "db-url"
    nginx:
      enabled: false
    ingress:
      enabled: true
      defaultBackend:
        enabled: true
      hosts:
        - packages.darkfellanetwork.com
      routerPath: /
      artifactoryPath: /artifactory/
      className: "nginx"
     annotations: 
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          rewrite ^/(v2)/token /artifactory/api/docker/null/v2/token;
          rewrite ^/(v2)/([^\/]*)/(.*) /artifactory/api/docker/$2/$1/$3;
      tls: 
      - secretName: artifactory-tls
        hosts:
          - packages.darkfellanetwork.com
