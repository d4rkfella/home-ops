---
helmDefaults:
  cleanupOnFail: true
  wait: true
  waitForJobs: true

releases:
  - name: cilium
    namespace: kube-system
    chart: oci://ghcr.io/home-operations/charts-mirror/cilium
    version: 1.18.4
    values: ['./templates/values.yaml.gotmpl']
    hooks:
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=kube-system
          - --field-manager=kustomize-controller
          - -f
          - ../../kubernetes/apps/kube-system/cilium/manifests/config.yaml
        showlogs: true

  - name: coredns
    namespace: kube-system
    chart: oci://ghcr.io/coredns/charts/coredns
    version: 1.45.0
    values: ['./templates/values.yaml.gotmpl']
    needs: ['kube-system/cilium']

  - name: kubelet-csr-approver
    namespace: kube-system
    chart: oci://ghcr.io/d4rkfella/charts-mirror/kubelet-csr-approver
    version: 1.2.12
    values: ['./templates/values.yaml.gotmpl']
    needs: ['kube-system/coredns']

  - name: cert-manager
    namespace: cert-manager
    chart: oci://quay.io/jetstack/charts/cert-manager
    version: v1.19.2
    values: ['./templates/values.yaml.gotmpl']
    needs: ['kube-system/kubelet-csr-approver']
    hooks:
      - events: ['presync']
        command: sh
        args:
          - -c
          - |
            sops -d ../../kubernetes/apps/cert-manager/cert-manager/manifests/issuer.secret.sops.yaml | kubectl apply --server-side --namespace=cert-manager --field-manager=kustomize-controller -f -
        showlogs: true
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=cert-manager
          - --field-manager=kustomize-controller
          - -f
          - ../../kubernetes/apps/cert-manager/cert-manager/manifests/clusterissuer.yaml
        showlogs: true

  - name: zfs-localpv
    namespace: openebs-system
    chart: oci://ghcr.io/d4rkfella/charts-mirror/zfs-localpv
    version: 2.9.0
    values: ['./templates/values.yaml.gotmpl']
    needs: ['cert-manager/cert-manager']
    hooks:
      - events: ["presync"]
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=kube-system
          - -f
          - ../create-zpool.yaml
        showlogs: true
      - events: ["presync"]
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=kube-system
          - -f
          - https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
          - -f
          - https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
          - -f
          - https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
        showlogs: true
      - events: ["postsync"]
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=openebs-system
          - --field-manager=kustomize-controller
          - -f
          - ../../kubernetes/apps/openebs-system/zfs-localpv/manifests/storageclass.yaml
          - -f
          - ../../kubernetes/apps/openebs-system/zfs-localpv/manifests/volumesnapshotclass.yaml

  - name: vault
    namespace: vault
    chart: oci://ghcr.io/d4rkfella/charts-mirror/vault
    version: 0.31.0
    values: ['./templates/values.yaml.gotmpl']
    needs: ['cert-manager/cert-manager']
    hooks:
      - events: ['presync']
        command: sh
        args:
          - -c
          - |
            sops -d ../../kubernetes/apps/vault/vault/manifests/vault.secret.sops.yaml | kubectl apply --server-side --namespace=vault --field-manager=kustomize-controller -f -
        showlogs: true
      - events: ['postsync']
        command: home-ops-cli
        args:
          - vault
          - bootstrap
          - --s3-bucket
          - hashicorp-vault-backup
          - --aws-profile
          - cloudflare
          - --filename-regex
          - 'backup-(\d{8}-\d{7})\.snap'
        showlogs: true

  - name: external-secrets
    namespace: external-secrets
    chart: oci://ghcr.io/external-secrets/charts/external-secrets
    version: 1.1.1
    values: ['./templates/values.yaml.gotmpl']
    needs: ['vault/vault']
    hooks:
      - events: ["postsync"]
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=cert-manager
          - --field-manager=kustomize-controller
          - -f
          - ../../kubernetes/apps/external-secrets/external-secrets/manifests/clustersecretstore.yaml

  - name: multus
    namespace: kube-system
    chart: oci://ghcr.io/bjw-s-labs/helm/multus
    version: 1.0.2
    values: ['./templates/values.yaml.gotmpl']
    needs: ['cert-manager/cert-manager']
    hooks:
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=kubevirt
          - --field-manager=kustomize-controller
          - --force-conflicts
          - --kustomize
          - ../../kubernetes/apps/kubevirt/kubevirt-operator/manifests
        showlogs: true
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=kubevirt
          - --field-manager=kustomize-controller
          - --force-conflicts
          - --kustomize
          - ../../kubernetes/apps/kubevirt/kubevirt-instance/manifests
        showlogs: true
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=cdi
          - --field-manager=kustomize-controller
          - --force-conflicts
          - --kustomize
          - ../../kubernetes/apps/cdi/cdi-operator/manifests
        showlogs: true
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=cdi
          - --field-manager=kustomize-controller
          - --force-conflicts
          - --kustomize
          - ../../kubernetes/apps/cdi/cdi-instance/manifests
        showlogs: true
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=virtualization
          - --field-manager=kustomize-controller
          - --kustomize
          - ../../kubernetes/apps/virtualization/truenas-scale/manifests
      - events: ['postsync']
        command: kubectl
        args:
          - apply
          - --server-side
          - --namespace=virtualization
          - --field-manager=kustomize-controller
          - --kustomize
          - ../../kubernetes/apps/virtualization/windows-server/manifests

  - name: flux-operator
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
    version: 0.36.0
    values: ['./templates/values.yaml.gotmpl']
    needs: ['kube-system/multus']

  - name: flux-instance
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance
    version: 0.36.0
    values: ['./templates/values.yaml.gotmpl']
    needs: ['flux-system/flux-operator']
