location /api {
    access_by_lua_block {
        -- Retrieve the access token from the user's session
        local session = require "resty.session".open()
        local access_token = session.data.access_token

        if access_token then
            -- Set the Authorization header with the access token
            ngx.req.set_header("Authorization", "Bearer " .. access_token)
        else
            -- If no access token is found, deny the request
            ngx.status = ngx.HTTP_UNAUTHORIZED
            ngx.say("Unauthorized: No access token found")
            ngx.exit(ngx.HTTP_UNAUTHORIZED)
        end
    }

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass_request_body on;
    proxy_pass_request_headers on;
    client_max_body_size 5g;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_pass https://prometheus-operated.observability.svc.cluster.local:8082;
}
